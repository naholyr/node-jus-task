#!/usr/bin/env node

const helper = require('../lib/helper');
const tasks = require('../index');
const path = require('path');
const fs = require('fs');

// Disable colors
if (process.argv.indexOf('--no-color') != -1) {
  helper.noColor = true;
}

if (process.env.NODE_DEBUG && process.env.NODE_DEBUG.match(/(true|yes|1)/i)) {
  helper.debugMode = true;
}

if (process.argv.indexOf('--help') != -1) {
  showHelp();
} else if (process.argv.indexOf('--version') != -1) {
  showVersion();
} else {
  try {
    tasks.runCLI(process.argv.slice(2));
  } catch (err) {
    showHelp(err);
  }
}

function showHelp(err) {
  var help = ''
    + helper.formatTitle('Usage') + '\n'
    + '  ' + process.title + ' [OPTIONS] [Task] [ARGUMENTS]\n'
    + '\n'
    + helper.getOptionsHelp({"Options:": [
        ['--help', null, 'Show this help and exit'],
        ['--version', null, 'Show version and exit'],
        ['--no-color', null, 'Disable ANSI color']
      ]})
    + '\n'
    + helper.colorize('Available tasks:', 'yellow') + '\n'
    + '  Call "' + process.title + ' list"\n';
  if (err) {
    helper.logError(err);
    console.log(help);
    if (helper.debugMode) {
      console.log('\n' + helper.formatTitle('Stack trace (debug):'));
      throw err;
    }
    process.exit(1);
  } else {
    console.log(help);
    process.exit(0);
  }
}

function showVersion() {
  try {
    var packageJson = JSON.parse(fs.readFileSync(__dirname + '/../package.json2'));
    helper.log(packageJson.version);
    process.exit(0);
  } catch (err) {
    helper.logError('Unable to retrieve version: cannot find jus-tasks\'s package.json');
    process.exit(1);
  }
}
